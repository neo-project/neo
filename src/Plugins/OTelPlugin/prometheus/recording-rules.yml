groups:
  - name: neo_recording_rules
    interval: 30s
    rules:
      # Block processing performance
      - record: neo:block_processing_time:p50_5m
        expr: histogram_quantile(0.50, sum(rate(neo_block_processing_time_bucket[5m])) by (le, instance))
      
      - record: neo:block_processing_time:p95_5m
        expr: histogram_quantile(0.95, sum(rate(neo_block_processing_time_bucket[5m])) by (le, instance))
      
      - record: neo:block_processing_time:p99_5m
        expr: histogram_quantile(0.99, sum(rate(neo_block_processing_time_bucket[5m])) by (le, instance))
      
      # Transaction processing rates
      - record: neo:transactions:rate_5m
        expr: sum(rate(neo_transactions_processed_total[5m])) by (instance, type)
      
      - record: neo:transactions:total_rate_5m
        expr: sum(rate(neo_transactions_processed_total[5m])) by (instance)
      
      # Network health indicators
      - record: neo:network:peer_churn_rate_5m
        expr: |
          (
            rate(neo_p2p_peer_disconnected_total[5m]) / 
            (rate(neo_p2p_peer_connected_total[5m]) + 0.001)
          )
      
      - record: neo:network:bandwidth_rate_5m
        expr: |
          rate(neo_p2p_bytes_sent_total[5m]) + 
          rate(neo_p2p_bytes_received_total[5m])
      
      # MemPool health
      - record: neo:mempool:unverified_ratio
        expr: |
          neo_mempool_unverified_count / 
          (neo_mempool_verified_count + neo_mempool_unverified_count + 0.001)
      
      - record: neo:mempool:avg_batch_removed_size_5m
        expr: |
          rate(neo_mempool_batch_removed_size_sum[5m]) / 
          (rate(neo_mempool_batch_removed_size_count[5m]) + 0.001)
      
      # Error rates
      - record: neo:errors:total_rate_5m
        expr: |
          sum(
            rate(neo_errors_protocol_total[5m]) + 
            rate(neo_errors_network_total[5m]) + 
            rate(neo_errors_storage_total[5m])
          ) by (instance)
      
      # Contract invocation performance
      - record: neo:contracts:invocation_rate_5m
        expr: sum(rate(neo_contracts_invocations_total[5m])) by (instance, contract_hash)
      
      - record: neo:contracts:failure_rate_5m
        expr: rate(neo_transaction_verification_failures_total[5m])
      
      # Sync status
      - record: neo:sync:blocks_behind_estimate
        expr: |
          # This would need to be adjusted based on your expected network height
          # For now, we'll track if the node is processing blocks
          (rate(neo_blockchain_height[5m]) > 0) * 1
      
      # Resource utilization
      - record: neo:mempool:memory_usage_mb
        expr: neo_mempool_memory_bytes / 1024 / 1024
      
      # Composite health score (0-100)
      - record: neo:health_score
        expr: |
          100 * (
            # Sync health (40%)
            0.4 * (neo_block_processing_rate > 0.1) +
            # Network health (30%)
            0.3 * (neo_p2p_connected_peers >= 5) * (neo_p2p_connected_peers / 20) +
            # MemPool health (20%)
            0.2 * (1 - neo_mempool_capacity_ratio) +
            # Error rate health (10%)
            0.1 * (1 - clamp_max(neo:errors:total_rate_5m / 10, 1))
          )