groups:
  - name: neo_blockchain_critical
    interval: 30s
    rules:
      # CRITICAL: Node is down
      - alert: NeoNodeDown
        expr: up{job="neo-node"} == 0
        for: 2m
        labels:
          severity: critical
          component: node
          team: blockchain-ops
        annotations:
          summary: "Neo node {{ $labels.instance }} is down"
          description: "Neo node {{ $labels.instance }} has been down for more than 2 minutes."
          runbook_url: "https://docs.neo.org/runbooks/node-down"
          dashboard_url: "http://grafana/d/neo-main?var-instance={{ $labels.instance }}"

      # CRITICAL: Blockchain sync stalled
      - alert: BlockchainSyncStalled
        expr: |
          (neo_blockchain_height - neo_blockchain_height offset 10m) == 0
          and neo_blockchain_is_syncing == 1
        for: 10m
        labels:
          severity: critical
          component: blockchain
          team: blockchain-ops
        annotations:
          summary: "Blockchain sync stalled on {{ $labels.instance }}"
          description: "Node {{ $labels.instance }} is syncing but block height hasn't changed for 10 minutes."
          runbook_url: "https://docs.neo.org/runbooks/sync-stalled"
          value: "Current height: {{ $value }}"

      # CRITICAL: No peers connected
      - alert: NoPeersConnected
        expr: neo_p2p_connected_peers == 0
        for: 5m
        labels:
          severity: critical
          component: p2p
          team: network-ops
        annotations:
          summary: "No peers connected to {{ $labels.instance }}"
          description: "Node {{ $labels.instance }} has no P2P connections for 5 minutes."
          runbook_url: "https://docs.neo.org/runbooks/no-peers"

  - name: neo_blockchain_warning
    interval: 30s
    rules:
      # WARNING: Low peer count
      - alert: LowPeerCount
        expr: neo_p2p_connected_peers < 3 and neo_p2p_connected_peers > 0
        for: 10m
        labels:
          severity: warning
          component: p2p
          team: network-ops
        annotations:
          summary: "Low peer count on {{ $labels.instance }}"
          description: "Node {{ $labels.instance }} has only {{ $value }} peers connected."
          runbook_url: "https://docs.neo.org/runbooks/low-peers"

      # WARNING: High block processing time
      - alert: HighBlockProcessingTime
        expr: |
          histogram_quantile(0.95, 
            rate(neo_block_processing_time_bucket[5m])
          ) > 1000
        for: 10m
        labels:
          severity: warning
          component: blockchain
          team: blockchain-ops
        annotations:
          summary: "High block processing time on {{ $labels.instance }}"
          description: "95th percentile block processing time is {{ $value }}ms (threshold: 1000ms)."
          runbook_url: "https://docs.neo.org/runbooks/slow-processing"

      # WARNING: MemPool nearly full
      - alert: MemPoolNearlyFull
        expr: neo_mempool_capacity_ratio > 0.8
        for: 5m
        labels:
          severity: warning
          component: mempool
          team: blockchain-ops
        annotations:
          summary: "MemPool nearly full on {{ $labels.instance }}"
          description: "MemPool is {{ $value | humanizePercentage }} full."
          runbook_url: "https://docs.neo.org/runbooks/mempool-full"

      # WARNING: High error rate
      - alert: HighErrorRate
        expr: |
          (
            rate(neo_protocol_errors_total[5m]) +
            rate(neo_network_errors_total[5m]) +
            rate(neo_storage_errors_total[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
          component: general
          team: blockchain-ops
        annotations:
          summary: "High error rate on {{ $labels.instance }}"
          description: "Error rate is {{ $value | humanize }} errors/sec."
          runbook_url: "https://docs.neo.org/runbooks/high-errors"

  - name: neo_performance
    interval: 30s
    rules:
      # WARNING: High CPU usage
      - alert: HighCPUUsage
        expr: process_cpu_usage > 80
        for: 10m
        labels:
          severity: warning
          component: system
          team: platform-ops
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "Process CPU usage is {{ $value | humanize }}%."
          runbook_url: "https://docs.neo.org/runbooks/high-cpu"

      # WARNING: High memory usage
      - alert: HighMemoryUsage
        expr: process_memory_working_set / (1024 * 1024 * 1024) > 4
        for: 10m
        labels:
          severity: warning
          component: system
          team: platform-ops
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Process is using {{ $value | humanize }}GB of memory."
          runbook_url: "https://docs.neo.org/runbooks/high-memory"

      # WARNING: Low block processing rate
      - alert: LowBlockProcessingRate
        expr: neo_block_processing_rate < 0.1 and neo_blockchain_is_syncing == 0
        for: 10m
        labels:
          severity: warning
          component: blockchain
          team: blockchain-ops
        annotations:
          summary: "Low block processing rate on {{ $labels.instance }}"
          description: "Block processing rate is {{ $value | humanize }} blocks/sec while not syncing."
          runbook_url: "https://docs.neo.org/runbooks/low-processing-rate"

  - name: neo_sla_violations
    interval: 30s
    rules:
      # CRITICAL: SLA violation - Availability
      - alert: SLAAvailabilityViolation
        expr: |
          (1 - (
            rate(up{job="neo-node"}[1h])
          )) > 0.001  # 99.9% availability
        for: 5m
        labels:
          severity: critical
          component: sla
          team: blockchain-ops
          sla_type: availability
        annotations:
          summary: "SLA availability violation on {{ $labels.instance }}"
          description: "Availability is below 99.9% SLA target. Current: {{ $value | humanizePercentage }}."
          runbook_url: "https://docs.neo.org/runbooks/sla-availability"

      # WARNING: SLA violation - Latency
      - alert: SLALatencyViolation
        expr: |
          histogram_quantile(0.99,
            rate(neo_block_processing_time_bucket[5m])
          ) > 2000
        for: 10m
        labels:
          severity: warning
          component: sla
          team: blockchain-ops
          sla_type: latency
        annotations:
          summary: "SLA latency violation on {{ $labels.instance }}"
          description: "P99 block processing time {{ $value }}ms exceeds 2000ms SLA."
          runbook_url: "https://docs.neo.org/runbooks/sla-latency"

  - name: neo_consensus
    interval: 30s
    rules:
      # CRITICAL: Consensus node issues
      - alert: ConsensusNodeOffline
        expr: |
          neo_consensus_state{consensus_enabled="true"} != 1
        for: 2m
        labels:
          severity: critical
          component: consensus
          team: consensus-ops
        annotations:
          summary: "Consensus node {{ $labels.instance }} is offline"
          description: "Consensus-enabled node is not participating in consensus."
          runbook_url: "https://docs.neo.org/runbooks/consensus-offline"

      # WARNING: Consensus delays
      - alert: ConsensusDelayed
        expr: |
          neo_consensus_time_to_finality > 30000
        for: 5m
        labels:
          severity: warning
          component: consensus
          team: consensus-ops
        annotations:
          summary: "Consensus delayed on {{ $labels.instance }}"
          description: "Time to finality is {{ $value }}ms (threshold: 30s)."
          runbook_url: "https://docs.neo.org/runbooks/consensus-delayed"

  - name: neo_capacity
    interval: 1m
    rules:
      # WARNING: Storage capacity
      - alert: StorageCapacityWarning
        expr: |
          neo_storage_size_bytes / (1024 * 1024 * 1024) > 100
        for: 30m
        labels:
          severity: warning
          component: storage
          team: platform-ops
        annotations:
          summary: "High storage usage on {{ $labels.instance }}"
          description: "Storage size is {{ $value | humanize }}GB."
          runbook_url: "https://docs.neo.org/runbooks/storage-capacity"

      # INFO: Predictive alerts
      - alert: BlockHeightGrowthAnomaly
        expr: |
          abs(
            (neo_blockchain_height - neo_blockchain_height offset 1h) -
            (neo_blockchain_height offset 1h - neo_blockchain_height offset 2h)
          ) / (neo_blockchain_height offset 1h - neo_blockchain_height offset 2h) > 0.5
        for: 30m
        labels:
          severity: info
          component: blockchain
          team: blockchain-ops
        annotations:
          summary: "Abnormal block height growth on {{ $labels.instance }}"
          description: "Block height growth rate changed by {{ $value | humanizePercentage }}."
          runbook_url: "https://docs.neo.org/runbooks/growth-anomaly"

  - name: neo_security
    interval: 30s
    rules:
      # CRITICAL: Potential security issues
      - alert: UnusualPeerBehavior
        expr: |
          rate(neo_p2p_peer_disconnected_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: security
          team: security-ops
        annotations:
          summary: "Unusual peer disconnection rate on {{ $labels.instance }}"
          description: "Peer disconnection rate is {{ $value | humanize }}/sec."
          runbook_url: "https://docs.neo.org/runbooks/peer-behavior"

      # WARNING: Transaction verification failures
      - alert: HighTransactionVerificationFailures
        expr: |
          rate(neo_transaction_verification_failures_total[5m]) > 0.1
        for: 10m
        labels:
          severity: warning
          component: security
          team: security-ops
        annotations:
          summary: "High transaction verification failure rate on {{ $labels.instance }}"
          description: "Transaction verification failing at {{ $value | humanize }}/sec."
          runbook_url: "https://docs.neo.org/runbooks/verification-failures"