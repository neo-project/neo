<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Condition=" '$(PluginOutDir)' != '' " Name="CleanPluginFiles" BeforeTargets="AfterClean">
    <PropertyGroup>
      <PluginOutDir>$([System.IO.Path]::GetFullPath('$(PluginOutDir)'))</PluginOutDir>
    </PropertyGroup>

    <ItemGroup>
      <PluginOutputFiles Include="$(PluginOutDir)/**/*.*" />
    </ItemGroup>

    <!-- Delete the plugin directory-->
    <Delete
      Files="%(PluginOutputFiles.Identity)"
      ContinueOnError="true" />

    <!-- Print Message To Output Window -->
    <Message
      Condition=" '%(PluginOutputFiles.Identity)' != '' "
      Text="$(MSBuildProjectName) -> Deleting: '%(PluginOutputFiles.FullPath)'"
      Importance="high" />
  </Target>

  <Target Condition=" '$(PluginOutDir)' != '' " Name="BeforeCopyPluginFiles" BeforeTargets="AfterBuild">
    <Message
      Text="------ Plugin copy started: Plugin: $(MSBuildProjectName), Folder: '$(PluginOutDir)/$(MSBuildProjectName)' ------"
      Importance="high" />
  </Target>

  <Target Condition=" '$(PluginOutDir)' != '' " Name="CopyPluginFiles" AfterTargets="BeforeCopyPluginFiles">
    <PropertyGroup>
      <OutDir>$([System.IO.Path]::GetFullPath('$(OutDir)'))</OutDir>
      <PluginOutDir>$([System.IO.Path]::GetFullPath('$(PluginOutDir)'))</PluginOutDir>
    </PropertyGroup>

    <ItemGroup>
      <PluginOutputFiles Include="$(OutDir)/*.*" />
      <PluginNativeFiles Include="$(OutDir)/runtimes/**" />
    </ItemGroup>

    <!-- Copy OutDir Contents -->
    <Copy
      SourceFiles="%(PluginOutputFiles.Identity)"
      DestinationFolder="$(PluginOutDir)/$(MSBuildProjectName)"
      OverwriteReadOnlyFiles="false"
      ContinueOnError="true"
      SkipUnchangedFiles="true">
      <Output
        TaskParameter="CopiedFiles"
        ItemName="PluginOutputFilesCopiedFiles" />
    </Copy>
    <Message
      Condition=" '%(PluginOutputFiles.Identity)' != '' "
      Text="$(MSBuildProjectName) -> Copying '%(PluginOutputFiles.FullPath)'"
      Importance="high" />

    <!-- Copy Runtime Dlls-->
    <Copy
      SourceFiles="%(PluginNativeFiles.Identity)"
      DestinationFolder="$(PluginOutDir)/$(MSBuildProjectName)/runtimes/%(PluginNativeFiles.RecursiveDir)"
      OverwriteReadOnlyFiles="false"
      ContinueOnError="true"
      SkipUnchangedFiles="true">
      <Output
        TaskParameter="CopiedFiles"
        ItemName="PluginNativeFilesCopiedFiles" />
    </Copy>
    <Message
      Condition=" '%(PluginNativeFiles.Identity)' != '' "
      Text="$(MSBuildProjectName) -> Copying '%(PluginNativeFiles.FullPath)'"
      Importance="high" />
  </Target>

  <Target Condition=" '$(PluginOutDir)' != '' " Name="AfterCopyPluginFiles" AfterTargets="CopyPluginFiles">
    <Message
      Text="========== Plugin copy completed: Plugin: $(MSBuildProjectName), Content: @(PluginOutputFilesCopiedFiles->Count()) files, Native: @(PluginNativeFilesCopiedFiles->Count()) files =========="
      Importance="high" />
  </Target>

</Project>
