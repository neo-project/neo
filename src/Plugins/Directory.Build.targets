<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Condition=" '$(PluginOutDir)' != '' " Name="CleanPluginFiles" AfterTargets="AfterClean">
    <ItemGroup>
      <PluginOutputFiles Include="$(PluginOutDir)/**/*.*" />
    </ItemGroup>

    <!-- Delete the plugin directory-->
    <Delete
      Files="%(PluginOutputFiles.Identity)"
      ContinueOnError="true" />

    <!-- Print Message To Output Window -->
    <Message
      Condition=" '%(PluginOutputFiles.Identity)' != '' "
      Text="$(MSBuildProjectName) -> Deleting: '%(PluginOutputFiles.FullPath)'"
      Importance="high" />
  </Target>

  <Target Condition=" '$(PluginOutDir)' != '' " Name="BeforeCopyPluginFiles" AfterTargets="AfterBuild">
    <Message
      Text="------ Plugin copy started: Plugin: $(MSBuildProjectName), Folder: '$(PluginOutDir)/$(MSBuildProjectName)' ------"
      Importance="high" />
  </Target>

  <Target Condition=" '$(PluginOutDir)' != '' " Name="CopyPluginFiles" AfterTargets="BeforeCopyPluginFiles">
    <PropertyGroup Condition=" '$(RuntimeIdentifier)' == '' ">
      <SystemPlatform Condition=" '$(Platform)' == 'x64' ">x64</SystemPlatform>
      <SystemPlatform Condition=" '$(Platform)' == 'ARM64' ">arm64</SystemPlatform>
      <SystemPlatform Condition=" '$(Platform)' == 'AnyCPU' ">x64</SystemPlatform>
      <SystemPlatform Condition=" '$(SystemPlatform)' == '' ">x64</SystemPlatform>
      <SystemOS Condition=" $([MSBuild]::IsOSPlatform('OSX')) == 'true' ">osx</SystemOS>
      <SystemOS Condition=" $([MSBuild]::IsOSPlatform('Linux')) == 'true' ">linux</SystemOS>
      <SystemOS Condition=" $([MSBuild]::IsOSPlatform('Windows')) == 'true' ">win</SystemOS>
      <SystemOS Condition=" '$(SystemOS)' == '' ">win</SystemOS>
      <RuntimeIdentifier>$(SystemOS)-$(SystemPlatform)</RuntimeIdentifier>
    </PropertyGroup>
    
    <PropertyGroup>
      <PluginOutDir Condition=" $([System.IO.Path]::IsPathRooted('$(PluginOutDir)')) != 'false' ">$([System.IO.Path]::GetFullPath('$(PluginOutDir)'))</PluginOutDir>
    </PropertyGroup>

    <ItemGroup>
      <PluginOutputFiles Include="$(OutDir)/*.*" />
      <PluginNativeFiles Include="$(OutDir)/runtimes/$(RuntimeIdentifier)/native/*.*" />
    </ItemGroup>

    <!-- Copy OutDir Contents -->
    <Copy
      SourceFiles="%(PluginOutputFiles.Identity)"
      DestinationFolder="$(PluginOutDir)/$(MSBuildProjectName)"
      OverwriteReadOnlyFiles="false"
      ContinueOnError="true"
      SkipUnchangedFiles="true">
      <Output
        TaskParameter="CopiedFiles"
        ItemName="PluginOutputFilesCopiedFiles" />
    </Copy>
    <Message
      Condition=" '%(PluginOutputFiles.Identity)' != '' "
      Text="$(MSBuildProjectName) -> Copying '%(PluginOutputFiles.FullPath)'"
      Importance="high" />

    <!-- Copy Runtime Dlls-->
    <Copy
      SourceFiles="%(PluginNativeFiles.Identity)"
      DestinationFolder="$(PluginOutDir)/$(MSBuildProjectName)"
      OverwriteReadOnlyFiles="false"
      ContinueOnError="true"
      SkipUnchangedFiles="true">
      <Output
        TaskParameter="CopiedFiles"
        ItemName="PluginNativeFilesCopiedFiles" />
    </Copy>
    <Message
      Condition=" '%(PluginNativeFiles.Identity)' != '' "
      Text="$(MSBuildProjectName) -> Copying '%(PluginNativeFiles.FullPath)'"
      Importance="high" />
  </Target>

  <Target Condition=" '$(PluginOutDir)' != '' " Name="AfterCopyPluginFiles" AfterTargets="CopyPluginFiles">
    <Message
      Text="========== Plugin copy completed: Plugin: $(MSBuildProjectName), Content: @(PluginOutputFilesCopiedFiles->Count()) files, Native: @(PluginNativeFilesCopiedFiles->Count()) files =========="
      Importance="high" />
  </Target>

</Project>
