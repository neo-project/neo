<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="CleanProjectPluginFiles" AfterTargets="AfterClean">
    <ItemGroup>
      <PluginOutputFiles Include="$(PluginOutDir)/**/*.*" />
    </ItemGroup>
    
    <!-- Delete the plugin directory-->
    <Delete
      Files="%(PluginOutputFiles.Identity)"
      ContinueOnError="true" />

    <!-- Print Message To Output Window -->
    <Message
      Condition=" '%(PluginOutputFiles.Identity)' != '' "
      Text="$(MSBuildProjectName) -> '%(PluginOutputFiles.FullPath)'"
      Importance="high" />
  </Target>

  <Target Name="BeforeCopyProjectPluginFiles" AfterTargets="AfterBuild;AfterRebuild">
    <Message
      Text="------ Plugin copy started: Plugin: $(MSBuildProjectName), Configuration: $(Configuration) $(Platform) ------"
      Importance="high" />
  </Target>

  <Target Name="CopyProjectPluginFiles" AfterTargets="AfterBuild;AfterRebuild" DependsOnTargets="BeforeCopyProjectPluginFiles">
    <PropertyGroup>
      <RuntimeIdentifier Condition=" '$(RuntimeIdentifier)' == '' ">win-x64</RuntimeIdentifier>
      <PluginOutDir Condition=" '$(PluginOutDir)' != '' ">$([System.IO.Path]::GetFullPath($(PluginOutDir)))</PluginOutDir>
    </PropertyGroup>
    
    <ItemGroup>
      <PluginOutputFiles Include="$(OutDir)/*.*" />
      <PluginNativeFiles Include="$(OutDir)/runtimes/$(RuntimeIdentifier)/native/*.*" />
    </ItemGroup>

    <!-- Copy OutDir Contents -->
    <Copy
      SourceFiles="%(PluginOutputFiles.Identity)"
      DestinationFolder="$(PluginOutDir)"
      OverwriteReadOnlyFiles="false"
      ContinueOnError="true"
      SkipUnchangedFiles="true">
      <Output
        TaskParameter="CopiedFiles"
        ItemName="PluginOutputFilesCopiedFiles" />
    </Copy>
    <Message
      Condition=" '%(PluginOutputFiles.Identity)' != '' "
      Text="$(MSBuildProjectName) -> '%(PluginOutputFiles.FullPath)' to '$(PluginOutDir)'"
      Importance="high" />

    <!-- Copy Runtime Dlls-->
    <Copy
      SourceFiles="%(PluginNativeFiles.Identity)"
      DestinationFolder="$(PluginOutDir)"
      OverwriteReadOnlyFiles="false"
      ContinueOnError="true"
      SkipUnchangedFiles="true">
      <Output
        TaskParameter="CopiedFiles"
        ItemName="PluginNativeFilesCopiedFiles" />
    </Copy>
    <Message
      Condition=" '%(PluginNativeFiles.Identity)' != '' "
      Text="$(MSBuildProjectName) -> '%(PluginNativeFiles.FullPath)' to '$(PluginOutDir)'"
      Importance="high" />
  </Target>

  <Target Name="AfterCopyProjectPluginFiles" AfterTargets="AfterBuild;AfterRebuild" DependsOnTargets="CopyProjectPluginFiles">
    <Message
      Text="========== Plugin copy completed: Plugin: $(MSBuildProjectName), Content: @(PluginOutputFilesCopiedFiles->Count()), Native: @(PluginNativeFiles->Count()) =========="
      Importance="high" />
  </Target>

</Project>
