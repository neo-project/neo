#!/usr/bin/expect -f
#
# Simple Neo CLI test for local verification
#
set timeout 30

# Set terminal size
if {[info exists env(COLUMNS)]} {
    stty columns $env(COLUMNS)
}
if {[info exists env(LINES)]} {
    stty rows $env(LINES)
}

# Get neo-cli path from command line or use default
if {[info exists argv] && [llength $argv] > 0} {
    set neo_cli_path [lindex $argv 0]
} else {
    set neo_cli_path "../../bin/Neo.CLI/net9.0/neo-cli.dll"
}

puts "Starting Neo CLI simple test..."

# Start neo-cli
spawn dotnet $neo_cli_path

# Wait for CLI to be ready
expect {
    "neo> " {
        puts "✓ CLI started successfully"
    }
    "Console window too small" {
        puts "✗ Console window size error"
        exit 1
    }
    timeout {
        puts "✗ Timeout waiting for CLI"
        exit 1
    }
}

# Test help command
send "help\n"
expect {
    "neo> " {
        puts "✓ Help command works"
    }
    timeout {
        puts "✗ Help command timeout"
        exit 1
    }
}

# Test version command
send "version\n"
expect {
    "neo> " {
        puts "✓ Version command works"
    }
    timeout {
        puts "✗ Version command timeout"
        exit 1
    }
}

# Test show pool (simple command)
send "show pool\n"
expect {
    "neo> " {
        puts "✓ Show pool command works"
    }
    timeout {
        puts "✗ Show pool command timeout"
        exit 1
    }
}

# Test wallet creation
send "create wallet test-simple.json\n"
expect {
    "password:" {
        send "testpass\n"
        expect {
            "password:" {
                send "testpass\n"
                expect {
                    "Address:" {
                        puts "✓ Wallet creation successful"
                        expect "neo> "
                    }
                    timeout {
                        puts "✗ Wallet creation timeout"
                        exit 1
                    }
                }
            }
        }
    }
    timeout {
        puts "✗ Wallet creation password prompt timeout"
        exit 1
    }
}

# Test list address
send "list address\n"
expect {
    "neo> " {
        puts "✓ List address works"
    }
    timeout {
        puts "✗ List address timeout"
        exit 1
    }
}

# Test exit
send "exit\n"
expect {
    eof {
        puts "✓ Exit successful"
    }
    timeout {
        puts "✗ Exit timeout"
    }
}

puts "\nSimple test completed successfully!"
exit 0