#!/usr/bin/expect -f
#
# Quick comprehensive test - subset of key functionality
#
set timeout 30

# Test counters
set tests_total 0
set tests_passed 0 
set tests_failed 0

# Terminal setup
if {[info exists env(COLUMNS)]} { stty columns $env(COLUMNS) }
if {[info exists env(LINES)]} { stty rows $env(LINES) }

# Test helper procedures
proc test_step {name} {
    global tests_total
    incr tests_total
    puts "→ Testing: $name"
}

proc test_pass {name} {
    global tests_passed
    incr tests_passed
    puts "  ✓ PASS: $name"
}

proc test_fail {name reason} {
    global tests_failed
    incr tests_failed
    puts "  ✗ FAIL: $name - $reason"
    exit 1
}

# Get CLI path
if {[info exists argv] && [llength $argv] > 0} {
    set neo_cli_path [lindex $argv 0]
} else {
    set neo_cli_path "../../bin/Neo.CLI/net9.0/neo-cli.dll"
}

puts "=== Quick Neo CLI Test ==="

# Test CLI startup
test_step "CLI startup"
spawn dotnet $neo_cli_path
expect {
    "neo> " { test_pass "CLI startup" }
    "Console window too small" { test_fail "CLI startup" "Console window too small" }
    timeout { test_fail "CLI startup" "Timeout" }
}

# Test help command
test_step "Help command"
send "help\n"
expect {
    "neo> " { test_pass "Help command" }
    timeout { test_fail "Help command" "Timeout" }
}

# Test version command  
test_step "Version command"
send "version\n"
expect {
    "neo> " { test_pass "Version command" }
    timeout { test_fail "Version command" "Timeout" }
}

# Test show pool (non-interactive)
test_step "Show pool command"
send "show pool\n"
expect {
    "neo> " { test_pass "Show pool command" }
    timeout { test_fail "Show pool command" "Timeout" }
}

# Test list native contracts
test_step "List native contracts"
send "list nativecontract\n"
expect {
    "neo> " { test_pass "List native contracts" }
    timeout { test_fail "List native contracts" "Timeout" }
}

# Exit gracefully
send "exit\n"
expect eof

puts "\n=== Test Summary ==="
puts "Total: $tests_total, Passed: $tests_passed, Failed: $tests_failed"

if {$tests_failed > 0} {
    puts "❌ QUICK TESTS FAILED"
    exit 1
} else {
    puts "✅ ALL QUICK TESTS PASSED"
    exit 0
}